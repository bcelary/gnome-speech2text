# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

GNOME Shell extension for local speech-to-text via whisper.cpp
- Extension (JS): GNOME Shell UI, keyboard shortcuts, dialogs
- Service (Python): D-Bus service, audio recording, whisper.cpp integration

## Commands

```bash
# Extension dev
make check                 # format + lint
make install-extension
./scripts/tail-logs.sh
# Debug: set DEBUG = true in src/lib/logger.js

# Service dev
cd service && make dev && make check
make kill-service          # restart service

# Install/test
make install && make status
```

## Architecture

Extension: extension.js, prefs.js, lib/{constants,dbusManager,recordingController,recordingDialog,uiManager,keybindingManager}.js
Service: service/src/speech2text_whispercpp_service/{service,whisper_cpp_client}.py

Flow: Keyboard -> RecordingController -> D-Bus StartRecording -> Service (FFmpeg+whisper.cpp) -> TranscriptionReady signal -> Preview/auto-type

D-Bus: org.gnome.Shell.Extensions.Speech2TextWhisperCpp
Signals: RecordingStarted, RecordingStopped, TranscriptionReady, RecordingError, TextTyped, TextCopied

## GNOME Extension Patterns (GNOME 46+)

**CRITICAL - Modern imports (never use imports.*):**
```javascript
// Platform (gi://)
import Gio from "gi://Gio";
import GLib from "gi://GLib";
import St from "gi://St";
import Clutter from "gi://Clutter";
import Meta from "gi://Meta";
import Shell from "gi://Shell";

// GTK4/Adwaita (prefs)
import Gtk from "gi://Gtk";
import Adw from "gi://Adw";

// GNOME Shell (resource://)
import * as Main from "resource:///org/gnome/shell/ui/main.js";
import * as ModalDialog from "resource:///org/gnome/shell/ui/modalDialog.js";
import { Extension } from "resource:///org/gnome/shell/extensions/extension.js";
import { ExtensionPreferences } from "resource:///org/gnome/Shell/Extensions/js/extensions/prefs.js";

// Project (relative)
import { UIManager } from "./lib/uiManager.js";
```

**Extension class:**
```javascript
export default class MyExtension extends Extension {
  enable() {
    this.settings = this.getSettings(SCHEMA_ID);
    this._signalId = obj.connect('signal', () => {...});
  }

  disable() {
    // MUST disconnect ALL signals, destroy UI, null refs
    if (this._signalId) obj.disconnect(this._signalId);
    this.settings = null;
  }
}
```

**CRITICAL - Signal cleanup (missing = memory leak/crash):**
```javascript
enable() {
  this._id = obj.connect('signal', () => {...});
}
disable() {
  if (this._id) obj.disconnect(this._id);
  this._id = null;
}
```

**D-Bus (from this project):**
```javascript
const XML = `<node><interface name="..."><method name="Foo">...</method></interface></node>`;
const Proxy = Gio.DBusProxy.makeProxyWrapper(XML);
this.proxy = new Proxy(Gio.DBus.session, "name", "/path");
const [result] = await this.proxy.FooAsync(arg);
this.proxy.connectSignal("Signal", (proxy, sender, [arg]) => {...});
```

**Prefs (GTK4/Adwaita):**
```javascript
export default class MyPreferences extends ExtensionPreferences {
  fillPreferencesWindow(window) {
    const settings = this.getSettings(SCHEMA_ID);
    const page = new Adw.PreferencesPage();
    const group = new Adw.PreferencesGroup({title: "Settings"});
    const row = new Adw.SwitchRow({title: "Enable"});
    settings.bind("key", row, "active", Gio.SettingsBindFlags.DEFAULT);
    group.add(row);
    page.add(group);
    window.add(page);
  }
}
```

**Keyboard shortcuts:**
```javascript
Main.wm.addKeybinding('key-name', this.settings, Meta.KeyBindingFlags.NONE,
  Shell.ActionMode.ALL, () => { /* handler */ });
// Cleanup: Main.wm.removeKeybinding('key-name');
```

## Project Rules

**Constants (src/lib/constants.js - single source of truth):**
- EXTENSION_UUID, SCHEMA_ID (must match metadata.json, schema file)
- DBUS_NAME, DBUS_PATH (must match service __init__.py)
- Renaming: update constants + metadata.json + service

**Schema:** org.gnome.shell.extensions.speech2text-whispercpp
**Keys:** toggle-recording, recording-duration, copy-to-clipboard, auto-type-enabled, preview-mode

**Service:** D-Bus activated, whisper-server in PATH, models in ~/.cache/whisper.cpp/
**Config:** WHISPER_MODEL, WHISPER_LANGUAGE, WHISPER_VAD_MODEL, WHISPER_SERVER_URL

## Common Tasks

**Add D-Bus feature:** Update XML (dbusManager.js + service) -> implement service.py -> handle recordingController.js

**Add setting:** Edit src/schemas/*.gschema.xml -> add UI in prefs.js -> bind/read -> run make compile-schemas

**Debug:** ./scripts/tail-logs.sh, LookingGlass (Alt+F2, 'lg'), reload: gnome-extensions disable UUID && enable UUID

## Notes

- X11: text insertion works. Wayland: clipboard only
- Memory leaks: missing signal disconnect = crashes
- Service changes: make kill-service (don't restart shell)
- Schema changes require: make compile-schemas
