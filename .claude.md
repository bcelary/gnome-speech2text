# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

GNOME Shell extension for local speech-to-text via whisper.cpp
- Extension (JS): GNOME Shell UI, keyboard shortcuts, dialogs
- Service (Python): D-Bus service, audio recording, whisper.cpp integration

## Dev Workflow

**Extension:**
```bash
make check                                          # format + lint FIRST
# Enable DEBUG = true in src/lib/logger.js
make uninstall-extension && make install-extension
# Alt+F2, type 'r', Enter (X11 only)
# Watch logs: journalctl --user -f
# Test changes...
# DISABLE debug in logger when done
```

**Service:**
```bash
cd service
make check                                          # format + lint FIRST
make status                                         # verify .venv binary active
# If pipx installed: make uninstall && make dev
# Watch logs: journalctl --user -f
# Changes active immediately (editable install)
```

## Architecture

**Flow:** Keyboard → KeybindingManager → DBusManager → Service (FFmpeg+whisper.cpp) → TranscriptionReady → UICoordinator → Preview/auto-type

**Key files:**
- D-Bus interface: service/data/org.gnome.Shell.Extensions.Speech2TextWhisperCpp.xml (src/lib/dbusManager.js must match)
- Schema: src/schemas/org.gnome.shell.extensions.speech2text-whispercpp.gschema.xml
- Constants: src/lib/constants.js, service/src/speech2text_whispercpp_service/constants.py

## GNOME Extension Patterns (GNOME 46+)

**References:**
- Extension development: https://gjs.guide/extensions/
- Review guidelines: https://gjs.guide/extensions/review-guidelines/review-guidelines.html

**CRITICAL - Modern imports (never use imports.*):**
```javascript
// Platform (gi://)
import Gio from "gi://Gio";
import GLib from "gi://GLib";
import St from "gi://St";
import Clutter from "gi://Clutter";
import Meta from "gi://Meta";
import Shell from "gi://Shell";

// GTK4/Adwaita (prefs)
import Gtk from "gi://Gtk";
import Adw from "gi://Adw";

// GNOME Shell (resource://)
import * as Main from "resource:///org/gnome/shell/ui/main.js";
import * as ModalDialog from "resource:///org/gnome/shell/ui/modalDialog.js";
import { Extension } from "resource:///org/gnome/shell/extensions/extension.js";
import { ExtensionPreferences } from "resource:///org/gnome/Shell/Extensions/js/extensions/prefs.js";

// Project (relative)
import { UIManager } from "./lib/uiManager.js";
```

**Extension class:**
```javascript
export default class MyExtension extends Extension {
  enable() {
    this.settings = this.getSettings();  // SCHEMA_ID is not required in modern Gnome shell versions
    this._signalId = obj.connect('signal', () => {...});
  }

  disable() {
    // MUST disconnect ALL signals, destroy UI, null refs
    if (this._signalId) obj.disconnect(this._signalId);
    this.settings = null;
  }
}
```

**CRITICAL - Signal cleanup (missing = memory leak/crash):**
```javascript
enable() {
  this._id = obj.connect('signal', () => {...});
}
disable() {
  if (this._id) obj.disconnect(this._id);
  this._id = null;
}
```

**D-Bus (from this project):**
```javascript
const XML = `<node><interface name="..."><method name="Foo">...</method></interface></node>`;
const Proxy = Gio.DBusProxy.makeProxyWrapper(XML);
this.proxy = new Proxy(Gio.DBus.session, "name", "/path");
const [result] = await this.proxy.FooAsync(arg);
this.proxy.connectSignal("Signal", (proxy, sender, [arg]) => {...});
```

**Prefs (GTK4/Adwaita):**
```javascript
export default class MyPreferences extends ExtensionPreferences {
  fillPreferencesWindow(window) {
    const settings = this.getSettings();
    const page = new Adw.PreferencesPage();
    const group = new Adw.PreferencesGroup({title: "Settings"});
    const row = new Adw.SwitchRow({title: "Enable"});
    settings.bind("key", row, "active", Gio.SettingsBindFlags.DEFAULT);
    group.add(row);
    page.add(group);
    window.add(page);
  }
}
```

**Keyboard shortcuts:**
```javascript
Main.wm.addKeybinding('key-name', this.settings, Meta.KeyBindingFlags.NONE,
  Shell.ActionMode.ALL, () => { /* handler */ });
// Cleanup: Main.wm.removeKeybinding('key-name');
```

## Project Rules

**Constants (single source of truth):**
- src/lib/constants.js: EXTENSION_UUID (match metadata.json), DBUS_NAME, DBUS_PATH
- service/src/speech2text_whispercpp_service/constants.py: DBUS_NAME, DBUS_PATH (must match extension)
- Renaming: update both constants files + metadata.json + schema file

**Service:** D-Bus activated, whisper-server in PATH, models in ~/.cache/whisper.cpp/

## Notes

- X11: text insertion works. Wayland: clipboard only
- Memory leaks: missing signal disconnect = crashes
- Service changes: make kill-service (don't restart shell)
